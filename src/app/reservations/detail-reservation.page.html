<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-menu-button slot="start"></ion-menu-button>
    <ion-title>Détails Réservation</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="terminerReservation()" *ngIf="reservation?.idReservation && canTerminateReservation()" color="success">
        <ion-icon name="checkmark"></ion-icon>
      </ion-button>
      <ion-button (click)="editReservation()" *ngIf="reservation?.idReservation">
        <ion-icon name="create"></ion-icon>
      </ion-button>
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Chargement...</p>
  </div>
  <div *ngIf="!isLoading && reservation" class="detail-container">
    <!-- En-tête avec numéro et statut -->
    <ion-card class="header-card">
      <ion-card-content>
        <div class="header-content">
          <div class="avatar-section">
            <ion-icon 
              [name]="getStatutIcon(reservation.statutReservation)" 
              [color]="getStatutColor(reservation.statutReservation)"
              class="status-icon-large">
            </ion-icon>
          </div>
          <div class="info-section">
            <h1>Réservation #{{ reservation.idReservation || 'N/A' }}</h1>
            <div class="badges-header">
              <ion-badge [color]="getStatutColor(reservation.statutReservation)">
                <ion-icon [name]="getStatutIcon(reservation.statutReservation)" style="margin-right: 4px;"></ion-icon>
                {{ reservation.statutReservation }}
              </ion-badge>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Informations client -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Client</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item lines="none" [button]="true" (click)="viewClient()" *ngIf="client">
          <ion-icon name="person" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Nom du client</h3>
            <p>{{ getClientName() }}</p>
          </ion-label>
        </ion-item>
        <ion-item lines="none" *ngIf="!client">
          <ion-icon name="person" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Client</h3>
            <p>Chargement...</p>
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Dates de la réservation -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Dates de la réservation</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item lines="none">
          <ion-icon name="calendar" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Date de création</h3>
            <p>{{ formatDateTime(reservation.dateReservation) }}</p>
          </ion-label>
        </ion-item>

        <ion-item lines="none">
          <ion-icon name="calendar" slot="start" color="success"></ion-icon>
          <ion-label>
            <h3>Date de début</h3>
            <p>{{ formatDate(reservation.dateDebut) }}</p>
          </ion-label>
        </ion-item>

        <ion-item lines="none">
          <ion-icon name="calendar" slot="start" color="danger"></ion-icon>
          <ion-label>
            <h3>Date de fin</h3>
            <p>{{ formatDate(reservation.dateFin) }}</p>
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Articles de la réservation -->
    <ion-card *ngIf="articles && articles.length > 0">
      <ion-card-header>
        <ion-card-title>Articles ({{ articles.length }})</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item *ngFor="let item of articles" lines="full" [button]="true" (click)="viewArticle(item.article)">
          <ion-icon name="cube" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>{{ item.article.nomArticle || 'Article non défini' }}</h3>
            <p>{{ item.article.prixLocationBase || 0 }} MAD/jour</p>
          </ion-label>
          <ion-badge slot="end" color="primary">
            Quantité: {{ item.quantite || 0 }}
          </ion-badge>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Message de débogage si aucun article (uniquement en développement) -->
    <ion-card *ngIf="!isLoading && reservation && (!articles || articles.length === 0)" class="debug-info">
      <ion-card-content>
        <p style="color: var(--ion-color-medium); font-style: italic; text-align: center;">
          Aucun article associé à cette réservation
        </p>
      </ion-card-content>
    </ion-card>

    <!-- Photo de la Carte d'Identité Nationale -->
    <ion-card *ngIf="reservation.photoCarteIdentite">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="id-card" slot="start"></ion-icon>
          Carte d'Identité Nationale
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="cin-photo-container">
          <img 
            [src]="reservation.photoCarteIdentite" 
            alt="Photo CIN"
            class="cin-photo"
            (error)="handleImageError($event)"
            (load)="handleImageLoad($event)">
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Bouton pour terminer la réservation -->
    <ion-card *ngIf="canTerminateReservation()">
      <ion-card-content>
        <ion-button expand="block" color="success" (click)="terminerReservation()">
          <ion-icon name="checkmark" slot="start"></ion-icon>
          Terminer la réservation
        </ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Informations financières -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Informations financières</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item lines="none">
          <ion-icon name="cash" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Montant total</h3>
            <p class="montant-total">{{ formatMontant(reservation.montantTotal) }}</p>
          </ion-label>
        </ion-item>

        <ion-item lines="none" *ngIf="reservation.remiseAppliquee > 0">
          <ion-icon name="wallet" slot="start" color="success"></ion-icon>
          <ion-label>
            <h3>Remise appliquée</h3>
            <p>{{ formatMontant(reservation.remiseAppliquee) }}</p>
          </ion-label>
        </ion-item>

        <ion-item lines="none" *ngIf="reservation.idPaiement">
          <ion-icon name="wallet" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Paiement associé</h3>
            <p>Paiement #{{ reservation.idPaiement }}</p>
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>

  </div>
</ion-content>

